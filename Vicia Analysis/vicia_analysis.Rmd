---
title: "Characterization of and selection on compound within-individual floral variation in *Vicia americana* (Fabaceae)"
author:
  - "Mason W. Kulbaba^[St. Mary's University, mason.kulbaba@stmu.ca, https://orcid.org/0000-0003-0619-7089]"
 
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  bookdown::pdf_document2:
    extra_dependencies: "amscd"
    number_sections: true
    toc: true
    toc_depth: 3
linkcolor: blue
urlcolor: blue
bibliography: vicia_refs.bib
#csl: journal-of-the-royal-statistical-society.csl
link-citations: true
---

# Abstract {-}

This document provides code to reproduce all results from the manuscript `Characterization of and selection on compound within-individual floral variation in *Vicia americana* (Fabaceae)`. The data file `vicia_final_data.csv` contains all data required to reproduce all results in the manuscript, and is located in the associated Zenodo repository. This study sought to describe the floral traits of *Vicia americana* as compound function-valued traits, and compare standardized linear selection estimates (e.g., $\beta$) as per @lande_measurement_1983, with the functional regression approached used by @kulbaba_inflorescence_2017 and @harder_dynamic_2019. 

# R

 * The version of R used to make this document is `r getRversion()`.

 * The version of the `rmarkdown` package used to make this document is
   `r packageVersion("rmarkdown")`.

 * The version of the `bookdown` package used to make this document is
   `r packageVersion("bookdown")`.

 * The version of the `dplyr` package used to make this document is
   `r packageVersion("dplyr")`.

 * The version of the `glmmTMB` package used to make this document is
   `r packageVersion("glmmTMB")`.

 * The version of the `DHARMa` package used to make this document is
   `r packageVersion("DHARMa")`.

 * The version of the `car` package used to make this document is
   `r packageVersion("car")`.

 * The version of the `caret` package used to make this document is
   `r packageVersion("caret")`.

 * The version of the `Hmisc` package used to make this document is
   `r packageVersion("Hmisc")`.
   
 * The version of the `tidyr` package used to make this document is
   `r packageVersion("tidyr")`.
   
 * The version of the `viridis` package used to make this document is
   `r packageVersion("viridis")`.
   
 * The version of the `refund` package used to make this document is
   `r packageVersion("refund")`.

Attach packages.
```{r package}

suppressMessages(library("dplyr"))
suppressMessages(library("glmmTMB"))
suppressMessages(library("ggplot2"))
suppressMessages(library("DHARMa"))
suppressMessages(library("car"))
suppressMessages(library("caret"))
suppressMessages(library("Hmisc"))
suppressMessages(library("tidyr"))
suppressMessages(library("viridis"))
suppressMessages(library("refund"))

```

# Data

Load data file
```{r aster-version}
data<- read.csv("vicia_final_data.csv")
```

where the variables are

 * `PlantID` is a unique numerical identifier for each individual in the study (1-40).

 * `Branch` is a unique numerical identifier for each sequentially produced raceme (1-10).
  The first raceme to flower was designated as 1, and was the most basal. 

 * `PosSeq` is the sequential flower position (1-49) across all sequentially flowering racemes.

 * `BPos` is a composite of `Branch` and `Pos` (see below), indicating the raceme-specific 
  flower position.

 * `Pos` is the individual flower position within each raceme.
 
 * `FL` is the length of flower.
  
 * `FD` is the diameter of the flower where the banner petal attaches.
   
 * `B` is the length (height) of the banner petal.
 
 * `Date` is the date of flower opening, and when the three floral measurements were made.
 
 * `flw_date` is the numerical day of the flowering season (1-17) the flower opened.
 
 * `FlwFate` is whether or not a flower produced fruit (0 = no, 1 = yes).
 
 * `seeds` is the number of seed produced in a given fruit. 
 
 * `aborted` is the number of aborted embryos.
 
 * `unfert` is the number of unfertilized ovules.
 
 * `Notes` records any specific notes for a given flower. 
 
 * `flw_vol` is flower volume as approximated as a cone ($V = \frac{1}{3} \pi \frac{FD^2}{2} FL$)

# Standardized Linear Selection (e.g., @lande_measurement_1983)

## Relative fitness (seeds)
```{r calculate relative fitness per plant}

#make sure PlantID is a factor
data$PlantID<- as.factor(data$PlantID)

#calculate total seed set (fitness) at plant level
plant.seeds<- aggregate(data$seeds, by=list(data$PlantID), sum)

#reset column names
colnames(plant.seeds)<- c("PlantID", "tot_seeds")

#calculate relative fitness
plant.seeds$rel_seeds<- plant.seeds$tot_seeds/(mean(plant.seeds$tot_seeds, na.rm=T))

#Check
head(plant.seeds)
```

## Standardized traits
First need to calculate mean values for each floral trait, and then subtract the mean and divide by the trait standard deviation to standardize each traits for each individual plant. 
```{r standardize traits}
#First calculate mean trait value for each trait (yes, not efficient, but I like to see the steps)
mean.B<- aggregate(data$B, by=list(data$PlantID), mean, na.rm=T)
mean.B$Group.1 <- NULL
colnames(mean.B)<- "mean.B"

mean.FL<- aggregate(data$FL, by=list(data$PlantID), mean, na.rm=T)
mean.FL$Group.1 <- NULL
colnames(mean.FL)<- "mean.FL"

mean.FD<- aggregate(data$FD, by=list(data$PlantID), mean, na.rm=T)
colnames(mean.FD)<- c("PlantID", "mean.FD")

```

Merge into a single dataframe (I know this is not efficient, I like to see the steps) with relative seed set
```{r merge into one object}
traits<- cbind(mean.B, mean.FL, mean.FD)

# add relative seed set
sel.data<- merge(traits, plant.seeds)

#check
sel.data

```


Now need to standardize individual plant mean (from above).
```{r standardize traits final}
#Calculate total (population) mean for each trait
sel.data$B_z<- (sel.data$mean.B - mean(sel.data$mean.B, na.rm = T))/sd(sel.data$mean.B, na.rm = T)
sel.data$FL_z<- (sel.data$mean.FL - mean(sel.data$mean.FL, na.rm = T))/sd(sel.data$mean.FL, na.rm = T)
sel.data$FD_z<- (sel.data$mean.FD - mean(sel.data$mean.FD, na.rm = T))/sd(sel.data$mean.FD, na.rm = T)

```



## Covariates
```{r aggregate covariates}
# total flowers
tot.flw<- aggregate(data$PosSeq, by=list(data$PlantID), max)
tot.flw$Group.1<- NULL

#total branches (racemes)
tot.branch<- aggregate(data$Branch, by=list(data$PlantID), max)
tot.branch$Group.1<- NULL
```

## Estimate ($\beta$)
Start with a poisson distribution. 
```{r linear selection estimates Poisson}
# model with standardized traits as fixed effects, and palntID as random  
# Fit Poisson model
fit_pois <- glmmTMB(rel_seeds ~ B_z + FL_z + FD_z, 
                    data = sel.data, family = poisson)

# Model diagnostics using DHARMa
sim_resid <- simulateResiduals(fit_pois, n = 1000)
plot(sim_resid)

# Test for overdispersion
testDispersion(sim_resid)

summary(fit_pois)


# Formal test for zero inflation
testZeroInflation(sim_resid) # not significant
```
The above model looks like a good fit (according to diagnostics), and not over dispersed. However, try fitting with a negative binomial distribution and compare AIC across two models.
```{r linear selection estimate Negative Binomial}
# Fit negative binomial model
fit_nb <- glmmTMB(rel_seeds ~ B_z + FL_z + FD_z, 
                    data = sel.data, family = nbinom2)

# Model diagnostics using DHARMa
sim_resid <- simulateResiduals(fit_nb, n = 1000)
plot(sim_resid)

# Test for overdispersion
testDispersion(sim_resid)

summary(fit_nb)

# Formal test for zero inflation
testZeroInflation(sim_resid) # not significant


AIC(fit_pois, fit_nb)
```
Both models fit well, and show the same pattern (significant effect of Banner height). As the AIC is slightly smaller with Poisson distribution, use this model.

Now produce a quick plot of the significant effect of banner height. A rather underwhelming figure.
```{r plotting selection gradient of banner height}

# Create prediction data over the range of standardized B
newdata <- data.frame(
  B_z = seq(min(sel.data$B_z), max(sel.data$B_z), length.out = 100),
  FL_z = 0,  # Hold other traits at their means (0 after standardization)
  FD_z = 0
)

# Predict expected seed number from the Poisson model
newdata$predicted_seeds <- predict(fit_pois, newdata, type = "response")

# Plot observed data and predicted curve
ggplot(sel.data, aes(x = B_z, y = tot_seeds)) +
  geom_point(alpha = 0.6, color = "gray30") +
  geom_line(data = newdata, aes(x = B_z, y = predicted_seeds), color = "blue", size = 1.2) +
  labs(
    x = "Standardized Banner Size (B)",
    y = "Seed Number (Fitness)",
    title = "Selection Gradient on Banner Size"
  ) +
  theme_minimal(base_size = 14)


```

# Floral Integration
Floral integration was described with correlation coefficients among floral traits. To explore if correlations among traits change across racemes, we compared correlation coefficients on racemes 1-5. To facilitate comparison among racemes, the first five flowers were used to calculate these correlations.
We calculated both within racemes (first five flowers), and among racemes (same position across first five racemes).
```{r correlations among floral traits}
# define function to extract, r, se, and P-value
get_cor_stats <- function(x, y) {
  ct <- cor.test(x, y, method = "pearson")
  r <- ct$estimate
  n <- sum(complete.cases(x, y))
  se <- sqrt((1 - r^2) / (n - 2))
  data.frame(correlation = r, se = se, p_value = ct$p.value)
}

```

## Withn raceme integration
Calculate within-inflorescence (raceme) floral integration.
```{r within raceme integration}
#within raceme integration
within_raceme <- data %>%
  filter(Branch %in% 1:5, Pos %in% 1:5) %>%
  group_by(Branch) %>%
  group_modify(~{
    df <- .
    bind_rows(
      get_cor_stats(df$FL, df$FD) %>% mutate(pair = "FL vs FD"),
      get_cor_stats(df$FL, df$B)  %>% mutate(pair = "FL vs B"),
      get_cor_stats(df$FD, df$B)  %>% mutate(pair = "FD vs B")
    )
  }) %>%
  ungroup() %>%
  select(Branch, pair, correlation, se, p_value)

within_raceme
```

Now make a nice little table with heatmap features to show pattern of floral integration with racemes, across the first five racemes.
```{r within-raceme integration table/map}
# prepare standard errors for inclusoin in table/heatmap
within_raceme <- within_raceme %>%
  mutate(sig = ifelse(p_value < 0.05, "*", ""),
         label = sprintf("%.2f\n(%.2f)%s", correlation, se, sig))

ggplot(within_raceme, aes(x = pair, y = factor(Branch), fill = correlation)) +
  geom_tile(color = "white") +
  geom_text(aes(label = label), color = "black", size = 4.2, lineheight = 0.9) +
  scale_fill_viridis(name = "Pearson r", limits = c(-1, 1)) +
  labs(
    title = "Trait Correlations Within First 5 Racemes",
    x = "Trait Pair", y = "Raceme (Branch #)",
    caption = "* indicates p < 0.001\n(SE shown in parentheses)"
  ) +
  theme_minimal(base_size = 13)
```


## Among raceme integration
```{r among raceme integration}
# among racemes
across_pos <- data %>%
  filter(Branch %in% 1:5, Pos %in% 1:5) %>%
  group_by(Pos) %>%
  group_modify(~{
    df <- .
    bind_rows(
      get_cor_stats(df$FL, df$FD) %>% mutate(pair = "FL vs FD"),
      get_cor_stats(df$FL, df$B)  %>% mutate(pair = "FL vs B"),
      get_cor_stats(df$FD, df$B)  %>% mutate(pair = "FD vs B")
    )
  }) %>%
  ungroup() %>%
  select(Pos, pair, correlation, se, p_value)

across_pos
```

Similar table as before, but now for same flower position (1-5) position across subsequently produced racemes.
```{r among-raceme integration table/map}
across_pos <- across_pos %>%
  mutate(sig = ifelse(p_value < 0.05, "*", ""),
         label = sprintf("%.2f\n(%.2f)%s", correlation, se, sig))

ggplot(across_pos, aes(x = pair, y = factor(Pos), fill = correlation)) +
  geom_tile(color = "white") +
  geom_text(aes(label = label), color = "black", size = 4.2, lineheight = 0.9) +
  scale_fill_viridis(name = "Pearson r", limits = c(-1, 1)) +
  labs(
    title = "Trait Correlations by Flower Position (Across Racemes)",
    x = "Trait Pair", y = "Flower Position",
    caption = "* indicates p < 0.001\n(SE shown in parentheses)"
  ) +
  theme_minimal(base_size = 13)
```

# References
